<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Club Trends Data</title>
</head>
<body>
    <h1>Club Trends Data</h1>
    <p>Data updates automatically every 30 seconds.</p>
    <pre id="output">Fetching data...</pre>

    <script>
        // Store the data globally so it can be accessed anywhere in the app
        let clubData = null;

        async function fetchClubTrendsData() {
            const maxAttempts = 5;
            const backoffTime = 1000; // In milliseconds
            let attempt = 0;

            while (attempt < maxAttempts) {
                try {
                    const currentGMT = new Date();
                    const timestamp = Math.floor(currentGMT.getTime() / 1000);

                    const headers = {
                        'User-Agent': 'Mozilla/5.0 (X11; Windows x86_64; rv:120.0) Gecko/20100101 Firefox/120.0',
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.5',
                        'Content-Type': 'application/json;charset=UTF-8',
                        'Authorization': 'Bearer <YOUR_TOKEN_HERE>', // Replace with your token
                        'Origin': 'https://91clubin.in',
                        'Connection': 'keep-alive',
                        'Referer': 'https://91clubin.in/',
                        'Sec-Fetch-Dest': 'empty',
                        'Sec-Fetch-Mode': 'cors',
                        'Sec-Fetch-Site': 'cross-site',
                    };

                    const jsonData = {
                        'pageSize': 10,
                        'pageNo': 1,
                        'typeId': 1,
                        'language': 0,
                        'random': 'f61ad7651a734f8c9de8f5b051bdb0f9',
                        'signature': '30423F9542005A1170A3C8D2ECA46E8E',
                        'timestamp': timestamp,
                    };

                    const response = await fetch('https://91clubapi.com/api/webapi/GetNoaverageEmerdList', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(jsonData),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    document.getElementById('output').textContent = JSON.stringify(data, null, 2);
                    
                    // Store the fetched data
                    clubData = data;
                    return data;
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, backoffTime));
                    } else {
                        document.getElementById('output').textContent = 'Failed to fetch data after multiple attempts.';
                    }
                }
            }
        }

        // Intercept requests to `/club.json` and return the JSON data
        window.addEventListener('popstate', function(event) {
            if (window.location.pathname === '/club.json' && clubData) {
                // If the user navigates to `/club.json`, show the JSON data
                document.getElementById('output').textContent = JSON.stringify(clubData, null, 2);
            }
        });

        // Manually handle requests to `/club.json`
        function handleClubJsonRequest() {
            if (window.location.pathname === '/club.json') {
                // Return the data as if it were coming from a JSON file
                document.getElementById('output').textContent = JSON.stringify(clubData, null, 2);
            }
        }

        // Automatically fetch data every 30 seconds
        fetchClubTrendsData(); // Fetch immediately on load
        setInterval(fetchClubTrendsData, 30000); // Fetch every 30 seconds

        // Handle the route change (like when navigating to `/club.json`)
        handleClubJsonRequest(); // Immediately handle current path

    </script>
</body>
</html>
